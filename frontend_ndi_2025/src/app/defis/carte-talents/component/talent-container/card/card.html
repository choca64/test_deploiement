<!-- MINI CARD -->
<div class="three-d-wrapper">
  <article class="card animated" #cardEl (click)="openModal()" 
           [style.background]="getCardTheme().bg"
           [style.--color1]="getCardTheme().color1"
           [style.--color2]="getCardTheme().color2">
    <div class="card__content">
      
      <!-- HEADER -->
      <header class="card__header">
        <div class="card__level-badge">
          <span class="level-label">Niveau</span>
          <span class="level-value">{{ getLevelNumber() }}</span>
        </div>
        
        <div class="card__identity">
          <h3 class="card__name">{{ talent.nom }}</h3>
          <p class="card__role-small">{{ talent.role }}</p>
        </div>
        
        <div class="card__xp">
          <span class="xp-label">XP</span>
          <span class="xp-value">{{ talent.xpActuel || getXP() }} ‚ö°</span>
        </div>
      </header>

      <!-- AVATAR SECTION -->
      <section class="card__avatar-section">
        @if (talent.stats) {
          <div class="card__stat-main">
            <span class="stat-name">{{ talent.stats.principale.nom }}</span>
            <div class="stat-bar-mini">
              <div class="stat-bar-mini__fill" [style.width.%]="talent.stats.principale.valeur"></div>
            </div>
          </div>
        }

        @if (talent.verified) {
          <div class="card__verified">
            <span>‚úì</span>
            <span>VERIFIED</span>
          </div>
        }

        <div class="card__avatar" [ngStyle]="avatarStyle()">
          {{ talent.nom.charAt(0).toUpperCase() }}
        </div>

        <div class="card__role-badge">
          <span class="category-tag">{{ talent.categorie || 'technique' }}</span>
          <span class="role-text">{{ talent.role }}</span>
        </div>
      </section>

      <!-- SKILLS -->
      <section class="card__skills">       
         @if (talent.competences?.[0]) {
          <div class="skill-row">
            <div class="skill-energies">
              <span class="energy" [ngClass]="'energy--' + getEnergyType(0)"></span>
            </div>
            <span class="skill-name">{{ talent.competences[0] }}</span>
            <span class="skill-damage">+{{ getSkillDamage(0) }}</span>
          </div>
        }

        @if (talent.competences?.[1]) {
          <div class="skill-row">
            <div class="skill-energies">
              <span class="energy" [ngClass]="'energy--' + getEnergyType(1)"></span>
              <span class="energy energy--rainbow"></span>
            </div>
            <span class="skill-name">{{ talent.competences[1] }}</span>
            <span class="skill-damage">+{{ getSkillDamage(1) }}</span>
          </div>
        }

        @if (talent.passions?.[0]) {
          <div class="skill-row skill-row--special">
            <div class="skill-energies">
              <span class="energy energy--rainbow"></span>
              <span class="energy energy--rainbow"></span>
              <span class="energy energy--rainbow"></span>
            </div>
            <span class="skill-name">
              {{ talent.passions[0] }}
              <span class="gx-tag">GX</span>
            </span>
            <span class="skill-damage">{{ getImpactDamage() }}</span>
          </div>
        }

        <p class="skill-quote">"{{ talent.style.citation || 'Un talent unique' }}"</p>
      </section>

      <!-- FOOTER -->
      <footer class="card__footer">
        <div class="footer-stat">
          <span class="footer-stat__label">Risque</span>
          <span class="footer-stat__value footer-stat__value--risk">{{ talent.limites.risqueEchec || 10 }}%</span>
        </div>

        <div class="footer-stat">
          <span class="footer-stat__label">Langues</span>
          <div class="footer-langs">
            @for (lang of talent.langues.slice(0, 3); track lang) {
              <span class="lang-tag">{{ lang }}</span>
            }
          </div>
        </div>

        <div class="footer-stat">
          <span class="footer-stat__label">Projets</span>
          <span class="footer-stat__value">{{ talent.projets.length || 0 }}</span>
        </div>
      </footer>

      <!-- CLICK HINT -->
      <div class="card__click-hint">
        <span>Cliquer pour voir plus</span>
      </div>

    </div>
  </article>
</div>

<!-- MODAL DETAIL VIEW -->
@if (isModalOpen) {
  <div class="modal-overlay" (click)="onOverlayClick($event)">
    <div class="modal-content">
      
      <!-- Close Button -->
      <button class="modal-close" (click)="closeModal()">‚úï</button>

      <!-- HORIZONTAL CARD LAYOUT -->
      <div class="detail-card">
        
        <!-- LEFT: Avatar & Identity -->
        <div class="detail-left">
          <div class="detail-avatar-zone">
            <div class="detail-avatar" [ngStyle]="avatarStyle()">
              {{ talent.nom.charAt(0).toUpperCase() }}
            </div>
            @if (talent.verified) {
              <div class="detail-verified">
                <span>‚úì</span> VERIFIED
              </div>
            }
          </div>
          
          <div class="detail-identity">
            <div class="detail-level">
              <span class="detail-level__label">Niveau</span>
              <span class="detail-level__value">{{ getLevelNumber() }}</span>
            </div>
            <h2 class="detail-name">{{ talent.nom }}</h2>
            <p class="detail-role">{{ getCategoryIcon() }} {{ talent.role }}</p>
            <div class="detail-xp">
              <span class="detail-xp__value">{{ talent.xpActuel || getXP() }}</span>
              <span class="detail-xp__label">XP ‚ö°</span>
            </div>
          </div>

          <div class="detail-meta">
            @if (talent.ville) {
              <span>üìç {{ talent.ville }}</span>
            }
            @if (talent.promo) {
              <span>üéì {{ talent.promo }}</span>
            }
            @if (talent.email) {
              <span>‚úâÔ∏è {{ talent.email }}</span>
            }
          </div>
        </div>

        <!-- CENTER: Stats & Skills -->
        <div class="detail-center">
          <div class="detail-section">
            <h3 class="detail-section__title">üìä Statistiques</h3>
            <div class="detail-stats">
              @if (talent.stats) {
                <div class="detail-stat">
                  <span class="detail-stat__name">{{ talent.stats.principale.nom }}</span>
                  <div class="detail-stat__bar">
                    <div class="detail-stat__fill" [style.width.%]="talent.stats.principale.valeur"></div>
                  </div>
                  <span class="detail-stat__value">{{ talent.stats.principale.valeur }}%</span>
                </div>
              }
              @for (stat of talent.stats.secondaires; track stat.nom) {
                <div class="detail-stat">
                  <span class="detail-stat__name">{{ stat.nom }}</span>
                  <div class="detail-stat__bar">
                    <div class="detail-stat__fill" [style.width.%]="stat.valeur"></div>
                  </div>
                  <span class="detail-stat__value">{{ stat.valeur }}%</span>
                </div>
              }
            </div>
          </div>

          <div class="detail-section">
            <h3 class="detail-section__title">‚ö° Comp√©tences</h3>
            <div class="detail-skills">
              @for (skill of getAllSkills(); track skill; let i = $index) {
                <span class="detail-skill">
                  <span class="energy-dot" [ngClass]="'energy--' + getEnergyType(i)"></span>
                  {{ skill }}
                  <span class="skill-pts">+{{ getSkillDamage(i) }}</span>
                </span>
              }
            </div>
          </div>

          @if (talent.passions.length) {
            <div class="detail-section">
              <h3 class="detail-section__title">‚ù§Ô∏è Passions</h3>
              <div class="detail-passions">
                @for (passion of talent.passions; track passion) {
                  <span class="detail-passion">{{ passion }}</span>
                }
              </div>
            </div>
          }
        </div>

        <!-- RIGHT: Extra Info -->
        <div class="detail-right">
          @if (getStrengths().length) {
            <div class="detail-section">
              <h3 class="detail-section__title">üí™ Forces</h3>
              <ul class="detail-list">
                @for (force of getStrengths(); track force) {
                  <li>{{ force }}</li>
                }
              </ul>
            </div>
          }

          @if (talent.langues.length) {
            <div class="detail-section">
              <h3 class="detail-section__title">üåç Langues</h3>
              <div class="detail-langs">
                @for (lang of talent.langues; track lang) {
                  <span class="detail-lang">{{ lang }}</span>
                }
              </div>
            </div>
          }

          @if (talent.projets.length) {
            <div class="detail-section">
              <h3 class="detail-section__title">üöÄ Projets</h3>
              <ul class="detail-list detail-list--projects">
                @for (projet of talent.projets; track projet) {
                  <li>{{ projet }}</li>
                }
              </ul>
            </div>
          }

          @if (talent.tags.length) {
            <div class="detail-section">
              <h3 class="detail-section__title">üè∑Ô∏è Tags</h3>
              <div class="detail-tags">
                @for (tag of talent.tags; track tag) {
                  <span class="detail-tag">{{ tag }}</span>
                }
              </div>
            </div>
          }

          @if (talent.style.citation) {
            <div class="detail-quote">
              <span class="quote-icon">"</span>
              <p>{{ talent.style.citation }}</p>
            </div>
          }

          <!-- CONTACT BUTTON -->
          <button class="detail-contact-btn" (click)="openContactModal($event)">
            <span>ü§ù</span> Contacter {{ talent.nom.split(' ')[0] }}
          </button>
        </div>

      </div>
    </div>
  </div>
}

<!-- CONTACT MODAL -->
@if (isContactModalOpen) {
  <div class="contact-modal-overlay" (click)="onOverlayClick($event)">
    <div class="contact-modal">
      <button class="contact-modal__close" (click)="closeContactModal()">‚úï</button>
      
      <!-- Success State -->
      @if (contactSent) {
        <div class="contact-success">
          <div class="success-icon">‚úÖ</div>
          <h3>Message envoy√© !</h3>
          <p>Votre message a √©t√© envoy√© √† {{ talent.nom }}.</p>
          @if (isLoggedIn) {
            <p class="success-hint">üí¨ Cliquez sur le bouton en bas √† droite pour voir vos conversations</p>
          }
          <button class="btn-close-success" (click)="closeContactModal()">Fermer</button>
        </div>
      }

      <!-- Form State -->
      @if (!contactSent) {
        <div class="contact-form">
          <div class="contact-header">
            <div class="contact-avatar" [ngStyle]="avatarStyle()">
              {{ talent.nom.charAt(0).toUpperCase() }}
            </div>
            <div class="contact-info">
              <h3>Contacter {{ talent.nom }}</h3>
              <p>{{ talent.role }}</p>
            </div>
          </div>

          <!-- Banni√®re utilisateur connect√© -->
          @if (isLoggedIn && currentUser) {
            <div class="logged-user-banner">
              <span class="user-avatar" [style.background]="currentUser.avatarColor">
                {{ (currentUser.displayName || currentUser.username).charAt(0) }}
              </span>
              <div class="user-info">
                <strong>{{ currentUser.displayName || currentUser.username }}</strong>
                <span>{{ currentUser.email }}</span>
              </div>
              <span class="badge-connected">‚úÖ Connect√©</span>
            </div>
          }

          <!-- Invitation √† se connecter -->
          @if (!isLoggedIn) {
            <div class="login-invite">
              <p>üí° <strong>Connectez-vous</strong> pour envoyer un message direct !</p>
              <button type="button" class="btn-login-invite" (click)="goToLogin()">
                Se connecter ‚Üí
              </button>
            </div>
          }

          <form (ngSubmit)="sendContactRequest()">
            <!-- Champs nom/email seulement si pas connect√© -->
            @if (!isLoggedIn) {
              <div class="form-row">
                <div class="form-field">
                  <label>Votre nom <span class="required">*</span></label>
                  <input 
                    type="text" 
                    [(ngModel)]="contactForm.fromName" 
                    name="fromName"
                    placeholder="Votre nom complet"
                    required>
                </div>
                <div class="form-field">
                  <label>Votre email <span class="required">*</span></label>
                  <input 
                    type="email" 
                    [(ngModel)]="contactForm.fromEmail" 
                    name="fromEmail"
                    placeholder="votre@email.com"
                    required>
                </div>
              </div>
            }

            <div class="form-field">
              <label>Type de demande</label>
              <select [(ngModel)]="contactForm.projectType" name="projectType">
                @for (type of projectTypes; track type.value) {
                  <option [value]="type.value">{{ type.label }}</option>
                }
              </select>
            </div>

            @if (!isLoggedIn) {
              <div class="form-field">
                <label>Comp√©tences recherch√©es (optionnel)</label>
                <input 
                  type="text" 
                  [(ngModel)]="contactForm.skills" 
                  name="skills"
                  placeholder="Ex: Angular, UX Design, Node.js">
                <span class="form-hint">S√©par√©es par des virgules</span>
              </div>
            }

            <div class="form-field">
              <label>Votre message <span class="required">*</span></label>
              <textarea 
                [(ngModel)]="contactForm.message" 
                name="message"
                rows="4"
                placeholder="Pr√©sentez votre projet ou votre demande..."
                required></textarea>
            </div>

            <div class="form-actions-split">
              <button type="button" class="btn-cancel" (click)="closeContactModal()">Annuler</button>
              
              <div class="form-actions-right">
                <!-- Bouton Proposer Collaboration -->
                <button type="button" class="btn-collab" 
                        (click)="sendCollaborationRequest()"
                        [disabled]="(!isLoggedIn && (!contactForm.fromName || !contactForm.fromEmail)) || !contactForm.message || isSendingMessage">
                  ü§ù Proposer collaboration
                </button>
                
                <!-- Bouton Envoyer Message (seulement si connect√©) -->
                @if (isLoggedIn) {
                  <button type="button" class="btn-send" 
                          (click)="sendMessageOnly()"
                          [disabled]="!contactForm.message || isSendingMessage">
                    @if (!isSendingMessage) {
                      <span>üí¨ Message</span>
                    }
                    @if (isSendingMessage) {
                      <span>‚è≥ Envoi...</span>
                    }
                  </button>
                }
              </div>
            </div>
          </form>
        </div>
      }
    </div>
  </div>
}
